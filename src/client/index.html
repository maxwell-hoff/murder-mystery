<script>
    let currentAction = '';
    let lobbyCode = '';
    let playerName = '';
    let pollingInterval;

    function handleCreateLobby(event) {
        event.preventDefault();
        currentAction = 'create';
        document.getElementById("create-join-section").classList.add("hidden");
        document.getElementById("name-popup").classList.remove("hidden");
    }

    function handleJoinLobby(event) {
        event.preventDefault();
        const lobbyCodeInput = document.getElementById("join-code").value;

        fetch("/check_lobby", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: lobbyCodeInput })
        })
        .then(response => {
            if (response.status === 404) {
                document.getElementById("error-message").classList.remove("hidden");
            } else {
                return response.json();
            }
        })
        .then(data => {
            if (data) {
                lobbyCode = lobbyCodeInput;
                document.getElementById("error-message").classList.add("hidden");
                document.getElementById("create-join-section").classList.add("hidden");
                document.getElementById("name-popup").classList.remove("hidden");
            }
        });
    }

    function submitPlayerName() {
        playerName = document.getElementById("player-name").value;
        if (playerName) {
            document.getElementById("name-popup").classList.add("hidden");
            document.getElementById("lobby-screen").classList.remove("hidden");

            if (currentAction === 'create') {
                fetch("/create", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rooms: document.getElementById("rooms").value,
                        players: document.getElementById("players").value,
                        player_name: playerName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    lobbyCode = data.lobby_code;
                    document.getElementById("lobby-code").innerText = lobbyCode;
                    generatePlayerList(data.max_players);
                    updatePlayerList(data.player_names, data.ready_statuses);
                    startPolling();  // Start polling after creating the lobby
                });
            } else if (currentAction === 'join') {
                fetch("/join", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: lobbyCode,
                        player_name: playerName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById("lobby-code").innerText = data.lobby_code;
                    generatePlayerList(data.max_players);
                    updatePlayerList(data.player_names, data.ready_statuses);
                    startPolling();  // Start polling after joining the lobby
                });
            }
        }
    }

    function generatePlayerList(maxPlayers) {
        const playerList = document.getElementById("player-list");
        playerList.innerHTML = '';
        for (let i = 0; i < maxPlayers; i++) {
            const row = document.createElement("tr");
            const playerCell = document.createElement("td");
            playerCell.id = `slot-${i + 1}`;
            playerCell.innerText = 'Waiting for player...';

            const statusCell = document.createElement("td");
            statusCell.id = `status-${i + 1}`;
            statusCell.innerText = '';

            row.appendChild(playerCell);
            row.appendChild(statusCell);
            playerList.appendChild(row);
        }
    }

    function updatePlayerList(playerNames, readyStatuses) {
        for (let i = 0; i < playerNames.length; i++) {
            document.getElementById(`slot-${i + 1}`).innerText = playerNames[i];
            document.getElementById(`status-${i + 1}`).innerText = readyStatuses[i] ? 'Ready' : '';
        }
    }

    function startPolling() {
        pollingInterval = setInterval(() => {
            fetch(`/lobby/${lobbyCode}`)
                .then(response => response.json())
                .then(data => updatePlayerList(data.player_names, data.ready_statuses));

            fetch(`/check_all_ready/${lobbyCode}`)
                .then(response => response.json())
                .then(data => {
                    if (data.all_ready) {
                        clearInterval(pollingInterval);
                        showAllReadyScreen();
                    }
                });
        }, 2000);
    }

    function setReadyStatus() {
        fetch(`/ready/${lobbyCode}`, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ player_name: playerName })
        });
    }

    function showAllReadyScreen() {
        document.getElementById("lobby-screen").classList.add("hidden");
        document.getElementById("all-ready-screen").classList.remove("hidden");
    }
</script>